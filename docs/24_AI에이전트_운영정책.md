# AI 에이전트 운영 정책 (Agent Operations Policy)
- 버전: 1.0
- 작성일: 2026-02-12
- 목적: AI 에이전트 조직의 모델 선택, 예산, 컨텍스트, 생애주기, 품질 관리 정책 정의
- 범위: 전사 적용 (L3 정책, 원칙 4: 기억 계층 분리)
- 관할: CTO + COO + CFO 공동 (원칙 5: 정책=매니저)

---

## 1) 모델 선택 거버넌스 (원칙 5: 정책=매니저)

### 복잡도별 모델 배정 규칙

| 복잡도 | 모델 | 최대 토큰 | 적용 기준 | 예시 작업 |
|--------|------|---------|----------|----------|
| **Trivial** | Haiku | 10K | 조회, 확인, 단순 응답 | "파일 읽기", "상태 확인", "정의 조회" |
| **Simple** | Haiku | 20K | 단순 수정, 1~2파일 변경 | "오타 수정", "주석 추가", "설정 변경" |
| **Standard** | Sonnet | 50K | 기능 구현, 버그 수정, 일반 검토 | "API 엔드포인트 추가", "유닛 테스트 작성" |
| **Complex** | Opus | 200K | 아키텍처 결정, 10개 이상 파일 | "시스템 리팩토링", "보안 아키텍처 설계" |
| **Analysis** | Codex/Gemini | 100K | 계획 검증, 디자인 리뷰, 대규모 분석 | "아키텍처 리뷰", "전체 코드베이스 분석" |

### 자동 라우팅 정책 (Policy-as-Code)

```javascript
function selectModel(task) {
  if (task.files.length >= 10) return "opus";
  if (task.type === "security" || task.type === "architecture") return "opus";
  if (task.type === "design" || task.type === "documentation") return "gemini";
  if (task.type === "read-only" || task.type === "query") return "haiku";
  if (task.complexity === "high") return "opus";
  if (task.complexity === "low") return "haiku";
  return "sonnet"; // default
}
```

### 강제 규칙 (위반 시 자동 차단)
- ❌ **금지**: 단순 조회에 Opus 사용 (비용 낭비)
- ❌ **금지**: 보안/정책 변경에 Haiku 사용 (품질 위험)
- ✅ **필수**: 10개 이상 파일 변경 시 Opus 이상 사용
- ✅ **필수**: 보안/정책 변경 시 Opus + Codex 이중 검증

---

## 2) 토큰 예산 관리 (원칙 5: 정책=매니저)

### BU별 토큰 예산 할당 (20_예산_비용배분_템플릿.md 참조)

| BU/본부 | 일간 한도 | 주간 한도 | 월간 한도 | 초과 시 조치 |
|---------|---------|---------|---------|-----------|
| BU1 (고객지원) | 20M | 120M | 500M | 자동 경고 (CFO) |
| BU2 (제품개발) | 12M | 70M | 300M | 자동 경고 (CFO) |
| BU3 (엔터프라이즈) | 8M | 50M | 200M | 자동 경고 (CFO) |
| BU4 (데이터·분석) | 6M | 35M | 150M | 자동 경고 (CFO) |
| 평가·품질본부 | 10M | 60M | 250M | 자동 경고 (CFO) |
| 운영본부 | 8M | 50M | 200M | 자동 경고 (CFO) |
| 보안·정책본부 | 4M | 25M | 100M | 자동 경고 (CFO) |

### 예산 초과 자동 조치 (Policy-as-Code)

```javascript
if (budget_used >= 95%) {
  blockNewTasks();
  restrictToHaiku();
  sendAlert(CFO, CEO);
}
if (budget_used >= 85%) {
  requireApprovalForOpus();
  sendAlert(CFO, BU_Leader);
}
if (budget_used >= 70%) {
  sendAlert(BU_Leader);
  enableDailyReport();
}
```

### 예산 최적화 정책
- **야간/주말 배치**: 저비용 모델 우선 (Haiku/Gemini Flash)
- **동일 작업 반복**: 캐싱 활용, 불필요한 재실행 방지
- **문서 작업**: Gemini Flash 강제 배정 (비용 1/5)
- **긴급 작업**: 예산 10% 예비금 활용 (COO 승인)

---

## 3) 컨텍스트 윈도우 관리 (원칙 4: 기억 계층 분리)

### 컨텍스트 계층 로딩 순서

```
[에이전트 스폰 시]
1. L3 (전사 정책) - 우선 로드, 절대 압축 금지
   - 보안 정책, 코딩 표준, 릴리즈 규칙, 5대 원칙
   - 저장 위치: config/enterprise-governance.json
   - 크기: ~50KB (priority notepad에 저장)

2. L2 (본부 SOP) - 해당 본부 전용 컨텍스트
   - 본부별 게이트 기준, KPI, 워크플로우
   - 저장 위치: config/department-sops/
   - 크기: ~100KB (작업 시작 시 로드)

3. L1 (프로젝트) - 프로젝트별 컨텍스트
   - PRD, 아키텍처, 기술 스택, CLAUDE.md
   - 저장 위치: .omc/state/, CLAUDE.md
   - 크기: ~200KB (세션 시작 시 로드)

4. L0 (작업) - 티켓별 컨텍스트
   - 티켓 설명, 관련 파일, 의존성
   - 저장 위치: ~/.claude/tasks/
   - 크기: 동적 (TaskGet으로 실시간 조회)
```

### 컨텍스트 압축 정책
- **L3 정책**: 절대 압축 금지 (priority notepad)
- **L2 SOP**: 압축 가능 (단, 복원 시 파일에서 재로드)
- **L1 프로젝트**: 압축 가능 (CLAUDE.md는 항상 재로드)
- **L0 작업**: 실시간 조회 (압축 대상 아님)

### 핸드오프 프로토콜 (에이전트 간 작업 이관)

```javascript
// 에이전트 A가 에이전트 B에게 작업 이관 시
handoff(taskId, targetAgent) {
  // 1. 현재 상태 요약 (200 토큰 이내)
  const summary = summarizeProgress(taskId);

  // 2. 핵심 컨텍스트만 전달 (L0 작업 컨텍스트)
  const context = {
    taskId,
    summary,
    filesModified: [...],
    nextSteps: [...]
  };

  // 3. 에이전트 B는 L3→L2→L1 순서로 재로드
  targetAgent.spawn({
    inheritContext: context,
    reloadPolicies: true // L3 정책 재로드 필수
  });
}
```

---

## 4) 에이전트 생애주기 (Lifecycle)

### 스폰(Spawn) 조건
- ✅ 명시적 Task 생성 (원칙 3: 티켓 기반)
- ✅ 권한 레벨 확인 (L0~L4)
- ✅ 예산 여유 확인 (토큰 한도)
- ✅ 적절한 모델 선택 (복잡도 기반)

### 실행 중 모니터링
- 토큰 사용량 실시간 추적
- 산출물 생성 진행률 (TaskUpdate)
- 정책 위반 감지 (보안, 품질)
- 무한 루프 방지 (동일 작업 3회 이상 반복 시 중단)

### 종료(Termination) 조건
- ✅ **정상 완료**: 산출물 생성 + 검증 통과 (원칙 2: Maker-Checker)
- ✅ **수동 종료**: 사용자/상위 에이전트 명령
- ⚠️ **예산 소진**: 토큰 한도 100% 도달
- ⚠️ **타임아웃**: 설정된 시간 초과 (기본 4시간)
- ❌ **정책 위반**: 보안 게이트 차단, 금지된 작업 시도
- ❌ **품질 실패**: 연속 3회 검증 실패

### 스케일링 기준 (에이전트 추가/제거)

| 상황 | 조치 | 승인 |
|------|------|------|
| 티켓 대기열 50개 이상 | 에이전트 +2 | BU 리더 |
| 티켓 대기열 100개 이상 | 에이전트 +5 | COO |
| 예산 90% 소진 | 에이전트 추가 중단 | CFO |
| 티켓 대기열 10개 미만 (3일간) | 에이전트 -1 | BU 리더 |

---

## 5) 환각(Hallucination) 방지 게이트 (원칙 2: 실행-검토 분리)

### 교차 검증 의무

| 산출물 유형 | 1차 실행 | 2차 검증 | 최종 승인 |
|-----------|---------|---------|----------|
| 코드 구현 | executor (Sonnet) | architect (Opus/Codex) | 평가·품질본부 |
| 보안 정책 | 보안기술팀 (Opus) | 준법팀 (Codex) | CISO |
| 아키텍처 설계 | architect (Opus) | 외부 Codex 리뷰 | CTO |
| 고객 응대 | 고객지원팀 (Sonnet) | QA (Haiku) | 없음 (사후 감사) |

### 환각 감지 자동 체크
```javascript
// Policy-as-Code
function detectHallucination(output) {
  // 1. 존재하지 않는 API 참조 감지
  if (output.includes("nonexistent_api_call")) return BLOCK;

  // 2. 정책 위반 (L3 정책과 충돌)
  if (violatesPolicy(output, L3_POLICIES)) return BLOCK;

  // 3. 외부 라이브러리 버전 불일치
  if (!verifyDependencyVersion(output)) return WARN;

  // 4. 테스트 없이 "완료" 선언
  if (output.status === "completed" && !output.testsRun) return BLOCK;

  return PASS;
}
```

### 검증 강제 규칙
- ❌ **금지**: 에이전트가 자신의 출력을 "검증 완료"로 선언
- ✅ **필수**: 다른 에이전트 또는 자동 테스트로 검증
- ✅ **필수**: 보안/정책 변경은 Opus + Codex 이중 검증
- ✅ **필수**: 코드 변경 시 lsp_diagnostics + 테스트 실행

---

## 6) Human-in-the-Loop (인간 개입 필수 항목)

### L4 의사결정 중 인간 승인 필수

| 의사결정 유형 | 자동 실행 가능? | 인간 승인 필요? | 승인자 |
|-------------|--------------|--------------|--------|
| 코드 구현 | ✅ 가능 | ❌ 불필요 (사후 검증) | - |
| 테스트 실행 | ✅ 가능 | ❌ 불필요 | - |
| 배포 (Staging) | ✅ 가능 | ❌ 불필요 (CAB 사전 승인) | - |
| 배포 (Production) | ⚠️ 조건부 | ✅ 필수 (고위험 시) | COO |
| 보안 정책 변경 | ❌ 불가 | ✅ 필수 | CISO |
| 예산 증액 | ❌ 불가 | ✅ 필수 | CFO → CEO |
| 전사 전략 변경 | ❌ 불가 | ✅ 필수 | CEO |
| 고객 데이터 삭제 | ❌ 불가 | ✅ 필수 | CISO + 법무 |
| SLA 조정 | ❌ 불가 | ✅ 필수 | COO + CEO |

### 인간 개입 프로토콜
1. 에이전트가 인간 승인 필요 감지
2. 티켓에 `requires_human_approval: true` 태그
3. 담당자에게 SendMessage 발송
4. 48시간 내 응답 없으면 에스컬레이션
5. 승인/거절 시 ADR 기록

---

## 7) 에이전트 성과 측정 (KPI)

### 산출물 품질 지표
| 지표 | 계산식 | 목표 |
|------|--------|------|
| 1차 검증 통과율 | (통과 / 전체) × 100% | >85% |
| 재작업률 | (재시도 / 전체) × 100% | <10% |
| 환각 감지율 | (차단 / 전체) × 100% | <5% |
| 정책 위반율 | (위반 / 전체) × 100% | <1% |

### 처리 시간 지표
| 지표 | 계산식 | 목표 |
|------|--------|------|
| 평균 완료 시간 | 총 소요 시간 / 완료 티켓 수 | <4시간 |
| P0 긴급 대응 시간 | P0 티켓 완료 시간 중앙값 | <2시간 |
| 대기 시간 | 티켓 생성~착수 시간 | <30분 |

### 비용 효율 지표
| 지표 | 계산식 | 목표 |
|------|--------|------|
| 티켓당 비용 | 총 비용 / 완료 티켓 수 | <$50 |
| 모델 선택 적정성 | 적정 모델 사용 / 전체 | >90% |
| 예산 준수율 | 실제 비용 / 예산 | <100% |

### 월간 성과 리포트 (CTO 주관)
- BU별/에이전트별 KPI 요약
- 상위/하위 10% 에이전트 분석
- 환각/정책 위반 사례 리뷰
- 개선 조치 및 교육 계획

---

## 8) 원칙 적용 매핑

### 원칙 1: 단일 산출물 책임
- ✅ 각 에이전트는 하나의 역할만 배정 (executor, architect, reviewer)
- ✅ 코드 작성 에이전트 ≠ 배포 승인 에이전트
- ✅ 겸임 금지 (executor가 verifier 역할 수행 불가)

### 원칙 2: 실행-검토 분리
- ✅ 실행 에이전트(executor) ≠ 검토 에이전트(architect)
- ✅ 자기 검증 금지 (self-review는 품질 게이트 아님)
- ✅ 최소 2-에이전트 체인: executor → architect → QA

### 원칙 3: 티켓 기반 실행
- ✅ 모든 에이전트 작업은 티켓에서 시작
- ✅ 티켓 없는 작업 자동 차단
- ✅ TaskCreate/TaskUpdate로 SSOT 유지

### 원칙 4: 기억 계층 분리
- ✅ L3 정책 → L2 SOP → L1 프로젝트 → L0 작업 순서로 로드
- ✅ L3 정책은 절대 압축 금지 (priority notepad)
- ✅ 핸드오프 시 L3 정책 재로드 필수

### 원칙 5: 정책=매니저
- ✅ 모델 선택, 예산 한도, 환각 감지가 자동 실행
- ✅ 정책 위반 시 자동 차단 (사람 개입 불필요)
- ✅ 예외는 명시적 승인 필수 (ADR 기록)

---

## 9) 체크리스트

### 에이전트 스폰 시
- [ ] 티켓 존재 확인 (원칙 3)
- [ ] 적절한 모델 선택 (복잡도 기반)
- [ ] 예산 여유 확인 (토큰 한도)
- [ ] L3→L2→L1→L0 순서로 컨텍스트 로드
- [ ] 권한 레벨 확인 (L0~L4)

### 에이전트 실행 중
- [ ] 토큰 사용량 모니터링
- [ ] 정책 위반 자동 감지
- [ ] 환각 방지 게이트 통과
- [ ] 진행률 업데이트 (TaskUpdate)

### 에이전트 종료 시
- [ ] 산출물 생성 확인
- [ ] 다른 에이전트로 검증 (원칙 2)
- [ ] 티켓 상태 업데이트 (completed)
- [ ] 성과 지표 기록 (KPI)

---

## 10) 승인

- 작성자:
- CTO 검토:
- COO 검토:
- CFO 검토:
- CEO 최종 승인:
- 승인 일자:
- 다음 리뷰 예정일: (분기 +3개월)
